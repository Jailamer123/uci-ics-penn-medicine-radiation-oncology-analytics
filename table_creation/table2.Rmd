---
title: "Table 2"
author: "Jessica George and Shawna Tuli"
date: "12/27/2020"
output: html_document
---

Libraries
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(survival)
library(finalfit)
library(survminer)
library(forestmodel)

# Check for collinearity using vif()
library(rms)
```

For Article 1, this is Table 2a
For Article 2, this is Table 2

Data Creation
```{r message=FALSE, warning=FALSE}
data <- read_csv("../data/data.csv") %>% 
  #filter(surgery == 0) %>% used for tables mentioned above
  mutate(
    age_cat = factor(age_cat, levels = c(1, 2, 3), labels = c("21-39", "40-59", ">60")),
    hiv_status = factor(hiv_status, levels = c(0, 1), labels = c("HIV-uninfected", "HIV-infected")),
    total_chemo_received_0 = factor(forcats::fct_recode(factor(total_chemo_received), "0" = "0", "1" = "1", "1" = "2", "1" = "3", "1" = "4", "1" = "5", "1" = "6", "1" = "7"), labels = c("0", ">0")),
    total_chemo_received_4 = factor(forcats::fct_recode(factor(total_chemo_received), "0" = "0", "0" = "1", "0" = "2", "0" = "3", "1" = "4", "1" = "5", "1" = "6", "1" = "7"), labels = c("<4", ">=4")),
    combined_cancer_stage = factor(combined_cancer_stage, levels = c(1, 2, 3, 4), labels = c("I (IB1*, IB2)", "II (IIA, IIB)", "III (IIIA, IIIB)", "IV")),
    cd4_cat = factor(case_when(hiv_status == "HIV-uninfected" ~ 1,
                               hiv_status == "HIV-infected" & cd4_final >= 500 ~ 2, 
                               hiv_status == "HIV-infected" & cd4_final >= 350 & cd4_final < 500 ~ 3,
                               hiv_status == "HIV-infected" & cd4_final >= 200 & cd4_final < 350 ~ 4,
                               hiv_status == "HIV-infected" & cd4_final < 200 ~ 5), levels = c(1,2,3,4)),
    time_alive = time_alive/365
  )

label(data$age_cat) <- "Age"
label(data$hiv_status) <- "HIV Status"
label(data$cr_result) <- "Baseline Cr"
label(data$hb_result) <- "Baseline Hb"
label(data$eqd2) <- "EQD2"
label(data$combined_cancer_stage) <- "Disease stage"
label(data$total_chemo_received_0) <- "No. of chemo cycles received"
label(data$total_chemo_received_4) <- "No. of chemo cycles received"
```

Original Proposed Cox Models for Whole Population
```{r}
explanatory1 <- c("age_cat", "cr_result", "hb_result", "combined_cancer_stage", "total_chemo_received_0", "eqd2")

explanatory2 <- c("age_cat", "cr_result", "hb_result", "combined_cancer_stage", "total_chemo_received_4", "eqd2")

dependent <- "Surv(time_alive, vital_status)"

# Table with chemo cycles (0 & >=0)
data %>% 
  finalfit(dependent, explanatory1) %>% 
  knitr::kable()

# Table with chemo cycles (<4 & >=4)
data %>% 
  finalfit(dependent, explanatory2) %>% 
  knitr::kable()
```
Possible issue of collinearity between hemoglobin, creatinine, and chemo in above Cox models

Collinearity Check

1) Using VIF
```{r}
model1 <- coxph(Surv(time_alive, vital_status) ~ age_cat + cr_result + hb_result + combined_cancer_stage + total_chemo_received_0 + eqd2, data = data)
vif(model1)

model2 <- coxph(Surv(time_alive, vital_status) ~ age_cat + cr_result + hb_result + combined_cancer_stage + total_chemo_received_4 + eqd2, data = data)
vif(model2)

model3 <- coxph(Surv(time_alive, vital_status) ~ cr_result + hb_result + total_chemo_received_0, data = data)
vif(model3)

model4 <- coxph(Surv(time_alive, vital_status) ~ cr_result + hb_result + total_chemo_received_4, data = data)
vif(model4)
```

2) Testing specific Cox models with variables of concern (hb, cr, chemo)

Goal: Lowest AIC
```{r}
# Testing between chemo cycles, hemoglobin, creatinine
# Chemo only
testmodel1 <- coxph(Surv(time_alive, vital_status) ~ hiv_status + age_cat + combined_cancer_stage + total_chemo_received_4 + eqd2, data = data)
summary(testmodel1)
AIC(testmodel1)

# Chemo and HB
testmodel2 <- coxph(Surv(time_alive, vital_status) ~ age_cat + hb_result + combined_cancer_stage + total_chemo_received_4 + eqd2, data = data)
summary(testmodel2)
AIC(testmodel2)

# Chemo and CR
testmodel3 <- coxph(Surv(time_alive, vital_status) ~ age_cat + cr_result + combined_cancer_stage + total_chemo_received_4 + eqd2, data = data)
summary(testmodel3)
AIC(testmodel3)

# From AIC results above, model 2 is the best for the whole population
```

Create Table 2 / 2a
```{r}
explanatory <- c("age_cat", "hiv_status", "hb_result", "combined_cancer_stage", "total_chemo_received_4", "eqd2")

# Adding cd4_cat
explanatory2 <- c("age_cat", "hiv_status", "hb_result", "cd4_cat", "combined_cancer_stage", "total_chemo_received_4", "eqd2")

dependent <- "Surv(time_alive, vital_status)"

# Table with chemo cycles (<4 & >=4)
data %>% 
  finalfit(dependent, explanatory) %>% 
  knitr::kable()

# data %>% 
#   finalfit(dependent, explanatory2) %>% 
#   knitr::kable()
```

Run whole population Cox model on HIV-infected and HIV-uninfected subpopulations
```{r}
stratified_explanatory <- c("age_cat", "hb_result", "combined_cancer_stage", "total_chemo_received_4", "eqd2")

# Adding cd4_cat
stratified_explanatory2 <- c("age_cat", "hb_result", "cd4_cat", "combined_cancer_stage", "total_chemo_received_4", "eqd2")

# HIV Pos
data %>% 
  filter(hiv_status == "HIV-infected") %>% 
  finalfit(dependent, stratified_explanatory) %>% 
  knitr::kable()

# Adding cd4_cat
# data %>% 
#   filter(hiv_status == "HIV-infected") %>% 
#   finalfit(dependent, stratified_explanatory2) %>% 
#   knitr::kable()

# HIV Neg
data %>% 
  filter(hiv_status == "HIV-uninfected") %>% 
  finalfit(dependent, stratified_explanatory) %>% 
  knitr::kable()

# Adding cd4_cat 
# data %>% 
#   filter(hiv_status == "HIV-uninfected") %>% 
#   finalfit(dependent, stratified_explanatory2) %>% 
#   knitr::kable()

## Also try combining stages 3 & 4
data_combined34stage <- data %>% 
  mutate(combined_cancer_stage = factor(combined_cancer_stage, levels = c("I (IB1*, IB2)", "II (IIA, IIB)", "III (IIIA, IIIB)", "IV"), labels = c("I (IB1*, IB2)", "II (IIA, IIB)", "III-IV (IIIA, IIIB, IV)", "III-IV (IIIA, IIIB, IV)")))

# Table 2
data_combined34stage %>% 
  finalfit(dependent, explanatory) %>% 
  knitr::kable()

# Adding cd4_cat
data_combined34stage %>% 
  finalfit(dependent, explanatory2) %>% 
  knitr::kable()

# HIV Pos
data_combined34stage %>% 
  filter(hiv_status == "HIV-infected") %>% 
  finalfit(dependent, stratified_explanatory) %>% 
  knitr::kable()

# Adding cd4_cat
data_combined34stage %>% 
  filter(hiv_status == "HIV-infected") %>% 
  finalfit(dependent, stratified_explanatory2) %>% 
  knitr::kable()

# HIV Neg
data_combined34stage %>% 
  filter(hiv_status == "HIV-uninfected") %>% 
  finalfit(dependent, stratified_explanatory) %>% 
  knitr::kable()

# Adding cd4_cat
data_combined34stage %>% 
  filter(hiv_status == "HIV-uninfected") %>% 
  finalfit(dependent, stratified_explanatory2) %>% 
  knitr::kable()
```

Create Table 2b
```{r}
explanatory <- c("age_cat", "hiv_status", "hb_result", "combined_cancer_stage_exact")

# Adding cd4_cat
explanatory2 <- c("age_cat", "hiv_status", "hb_result", "cd4_cat")

dependent <- "Surv(time_alive, vital_status)"

# Table with chemo cycles (<4 & >=4)
data %>% 
  filter(surgery == 1) %>%
  mutate(combined_cancer_stage_exact = factor(case_when(
    combined_cancer_stage_exact == "1.0" ~ 1, 
    combined_cancer_stage_exact == "2.0" ~ 1,
    combined_cancer_stage_exact == "3.0" ~ 1,
    combined_cancer_stage_exact == "4.0" ~ 2,
    combined_cancer_stage_exact == "5.0" ~ 2))) %>% 
  finalfit(dependent, explanatory) %>% 
  knitr::kable()

data %>%
  filter(surgery == 1) %>% 
  finalfit(dependent, explanatory2) %>%
  knitr::kable()

```